{% extends "layouts/layout.njk" %}

{% from "partials/breadcrumbs.njk" import breadcrumbs %}

{% block content %}
<div class="container my-5">
  {{ breadcrumbs([{ label: "Home", url: "/" }, { label: "Learn Activities", url: "/activities/learn" }, { label: "Edit", url: "#" }]) }}
  <h1 class="mb-4">Edit Learn Activity</h1>
  <form id="learnForm" action="/api/learn/update/{{ learnActivity.id }}" method="POST" enctype="multipart/form-data">
    <div class="mb-5">
      <label for="title" class="form-label">Title</label>
      <input type="text" class="form-control" id="title" name="title" value="{{ learnActivity.title }}" required>
    </div>
    <div class="mb-5">
      <label for="subTitle" class="form-label">Subtitle</label>
      <input type="text" class="form-control" id="subTitle" name="subTitle" value="{{ learnActivity.subTitle }}">
    </div>
    <div class="mb-5">
      <label for="instructor" class="form-label">Instructor</label>
      <input type="text" class="form-control" id="instructor" name="instructor" value="{{ learnActivity.instructor }}">
    </div>
    <div class="mb-5">
      <label for="featureImage" class="form-label">Feature Image</label>
      {% if learnActivity.featureImage %}
        <div class="mb-2">
          <img src="{{ learnActivity.featureImage }}" alt="Feature Image" style="max-width: 200px;">
          <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" id="removeFeatureImage" name="removeFeatureImage" value="true">
            <label class="form-check-label" for="removeFeatureImage">
              Remove current image
            </label>
          </div>
        </div>
      {% endif %}
      <input type="file" class="form-control" id="featureImage" name="featureImage" accept="image/*">
      <div class="form-text">Upload a new image to replace the current one.</div>
    </div>
    <div class="mb-5">
      <label for="description" class="form-label">Description</label>
      <textarea class="form-control" id="description" name="description" rows="3">{{ learnActivity.description }}</textarea>
    </div>
    <div class="mb-5">
      <label for="communityScore" class="form-label">Community Score</label>
      <input type="number" class="form-control" id="communityScore" name="communityScore" min="0" max="100" value="{{ learnActivity.communityScore }}">
    </div>
    <div class="mb-5">
      <label class="form-label">Videos</label>
      <div id="videoFields">
        {% for video in learnActivity.videos %}
          <div class="input-group mb-2 align-items-center">
            <input type="hidden" name="existingVideos" value='{{ video | dump | safe }}'>
            <input type="text" class="form-control" name="existingVideoTitles" value="{{ video.title }}" required>
            {% if video.url %}
              <a href="{{ video.url }}" target="_blank" class="btn btn-outline-secondary mx-2">View Current</a>
            {% endif %}
            <input type="file" class="form-control" name="videoFiles" accept="video/*">
            <button type="button" class="btn btn-danger remove-video ms-2">Remove</button>
          </div>
        {% endfor %}
        <!-- For new videos -->
        <div class="input-group mb-2 align-items-center">
          <input type="text" class="form-control" name="videoTitles" placeholder="Video Title" required>
          <input type="file" class="form-control" name="videoFiles" accept="video/*">
          <button type="button" class="btn btn-danger remove-video ms-2">Remove</button>
        </div>
      </div>
      <button type="button" id="addVideo" class="btn btn-secondary mt-2">Add Video</button>
    </div>
    <div class="mb-5">
      <label class="form-label">Audios</label>
      <div id="audioFields">
        {% for audio in learnActivity.audios %}
          <div class="input-group mb-2 align-items-center">
            <!-- Hidden field for backend to keep existing audio object -->
            <input type="hidden" name="existingAudios" value='{{ audio | dump | safe }}'>
            <!-- Editable title for existing audio (optional, for display only) -->
            <input type="text" class="form-control" name="existingAudioTitles" value="{{ audio.title }}" required>
            {% if audio.url %}
              <a href="{{ audio.url }}" target="_blank" class="btn btn-outline-secondary mx-2">Listen</a>
            {% endif %}
            <!-- Option to upload a new file to replace existing audio -->
            <input type="file" class="form-control" name="audioFiles" accept="audio/*">
            <button type="button" class="btn btn-danger remove-audio ms-2">Remove</button>
          </div>
        {% endfor %}
        <!-- For new audios -->
        <div class="input-group mb-2 align-items-center">
          <input type="text" class="form-control" name="audioTitles" placeholder="Audio Title" required>
          <input type="file" class="form-control" name="audioFiles" accept="audio/*">
          <button type="button" class="btn btn-danger remove-audio ms-2">Remove</button>
        </div>
      </div>
      <button type="button" id="addAudio" class="btn btn-secondary mt-2">Add Audio</button>
    </div>
    <button type="submit" class="btn btn-primary">Save Changes</button>
  </form>
  <script>
    document.getElementById('addVideo').addEventListener('click', function () {
      const videoFields = document.getElementById('videoFields');
      const div = document.createElement('div');
      div.className = 'input-group mb-2 align-items-center';
      div.innerHTML = `
        <input type="text" class="form-control" name="videoTitles" placeholder="Video Title" required>
        <input type="file" class="form-control" name="videoFiles" accept="video/*">
        <button type="button" class="btn btn-danger remove-video ms-2">Remove</button>
      `;
      videoFields.appendChild(div);
    });

    document.getElementById('addAudio').addEventListener('click', function () {
      const audioFields = document.getElementById('audioFields');
      const div = document.createElement('div');
      div.className = 'input-group mb-2 align-items-center';
      div.innerHTML = `
        <input type="text" class="form-control" name="audioTitles" placeholder="Audio Title" required>
        <input type="file" class="form-control" name="audioFiles" accept="audio/*">
        <button type="button" class="btn btn-danger remove-audio ms-2">Remove</button>
      `;
      audioFields.appendChild(div);
    });

    document.addEventListener('click', function (event) {
      if (event.target.classList.contains('remove-video')) {
        const group = event.target.parentElement;
        group.remove();
      }
      if (event.target.classList.contains('remove-audio')) {
        const group = event.target.parentElement;
        group.remove();
      }
    });

    document.getElementById('learnForm').addEventListener('submit', async function (event) {
      event.preventDefault();
      const formData = new FormData(this);

      try {
        const response = await fetch(this.action, {
          method: 'PUT',
          body: formData
        });

        if (response.ok) {
          alert('Learn activity updated successfully!');
          window.location.href = '/activities/learn';
        } else {
          const errorData = await response.json();
          alert(`Failed to update learn activity: ${errorData.message || 'Unknown error'}`);
        }
      } catch (error) {
        console.error('Error updating learn activity:', error);
        alert('An error occurred. Please try again.');
      }
    });
  </script>
</div>
{% endblock %}
